<html ng-app='ticTacToe'>
<style>
    .spot {
	    border: 1px solid black;
		width: 98px;
		height: 98px;
		float: left;
		font-size: 80px;
	}
	
	#messageBox {
	    margin-left: auto; 
		margin-right: auto;
		width: 258px;
		margin-top: 40px; 
		border: 1px solid black; 
		background-color: white; 
		clear: both; 
		font-size: 40px; 
		padding: 20px
	}
</style>
<script src='angular.js'></script>
<script>
angular.module('ticTacToe', []);

function Ctrl($scope, $http) {			
	$scope.fillIn = function(spot) {
	    if ($scope.team == 'X') {
		    var computerTeam = "O";
		} else {
		    var computerTeam = "X";
	    }
		
	    if (!$scope.gameOver) {
			if (spot.state == "") {
				spot.state = $scope.team;
										
				if ($scope.won($scope.spots)) {
					$scope.outcomeText = "You won";
					$scope.messageVisibile= true;
					$scope.gameOver = true;
				} else if ($scope.draw($scope.spots)) {
                    $scope.outcomeText = "Draw!";
					$scope.messageVisibile = true;
					$scope.gameOver = true;
                } else {						
					$scope.spots[$scope.solution[spot.id].response].state = computerTeam;
					$scope.solution = $scope.solution[spot.id];
					if ($scope.won($scope.spots)) {
					    console.log("Computer won");
						$scope.outcomeText = "Computer won";
						$scope.messageVisibile = true;						
						$scope.gameOver = true;
					} else if ($scope.draw($scope.spots)) {
						$scope.outcomeText = "Draw!";
						$scope.messageVisibile = true;
						$scope.gameOver = true;
					}
				}
			}
		}
	}
	
	$scope.draw = function(spots) {
	    var filledSpots = 0;
	    for (i = 0; i < spots.length; i++) {
		    if (spots[i]["state"] != '') {
			    filledSpots++;
			}
		}
		
		if (filledSpots == 9) {
		    return true;
		} else {
		    return false;
		}
	}
	
	$scope.won = function(spots) {
	    var teams = ["O", "X"];
	    for (var j = 0; j < 2; j++) {
			for (var x = 0; x < 3; x++) {
				var filledSpots = 0;
				for (var i = 0; i < $scope.spots.length; i++) {
					if ($scope.spots[i].row == x) {
						if ($scope.spots[i].state == teams[j]) {
							filledSpots++;
						}
					}
				}
				if (filledSpots == 3) {
					return true;
				}
			}

			for (y = 0; y < 3; y++) {
				var filledSpots = 0;
				for (var i = 0; i < $scope.spots.length; i++) {
					if ($scope.spots[i].col == y) {
						if ($scope.spots[i].state == teams[j]) {
							filledSpots++;
						}
					}
				}
				if (filledSpots == 3) {
					return true;
				}
			}
			var filledSpots = 0;
			for (var i = 0; i < $scope.spots.length; i++) {
				if ($scope.spots[i].col == $scope.spots[i].row) {
					if ($scope.spots[i].state == teams[j]) {
						filledSpots++;
					}
				}
			}
			if (filledSpots == 3) {
				return true;
			}
			var filledSpots = 0;
			for (var i = 0; i < $scope.spots.length; i++) {
				if ($scope.spots[i].col == 2 - $scope.spots[i].row) {
					if ($scope.spots[i].state == teams[j]) {
						filledSpots++;
					}
				}
			}
			if (filledSpots == 3) {
				return true;
			}			
			
		}
		return false;		
	};	
	
	$scope.startGame = function() {
	    if ($scope.team == 'X') {
		    solutionFile = 'TTTOSolution.json';
		} else {
		    solutionFile = 'TTTXSolution.json';
		}
	
	    $http.get(solutionFile).success( function(solutionData) {
		    $scope.solution = solutionData;
			if ($scope.team == "O") {
			    console.log($scope.solution);
				$scope.spots[$scope.solution["response"]].state = "X";
			}
			$scope.gameOver = false;
		});
		
		$scope.messageVisibile = false;

        $scope.spots = [];		
		for (var y = 0; y < 3; y++) {
			for (var x = 0; x < 3; x++) {
				$scope.spots[$scope.spots.length] = {row: x, col: y, state: "", id: x+(y*3)};
			}
	    }
	}
	
	$scope.team = "X";
	
	$scope.startGame();
}

// Function taken from Stack Overflow

function clone(obj){
    if(obj == null || typeof(obj) != 'object')
        return obj;

    var temp = obj.constructor(); // changed

    for(var key in obj)
        temp[key] = clone(obj[key]);
    return temp;
}

</script>
<body ng-controller='Ctrl'>
    <h1 style='text-align: center'>Tic Tac Toe!</h1>
	<div style='margin: auto; width: 300px; margin-bottom: 20px'>
	    <input type='radio' ng-model='team' ng-change='startGame()' value='X' />Play first (X)<span style='margin-right: 50px'> </span>
		<input type='radio' ng-model='team' ng-change='startGame()' value='O' />Play second (O)
	</div>
	<div style='width: 300px; height: 300px; margin: auto; margin-bottom: 40px;'>
    	<div class='spot' ng-repeat='spot in spots' ng-click='fillIn(spot)'>{{spot.state}}</div> 
    </div>

	<div id='messageBox'  ng-if='messageVisibile'>
		<div style='text-align: center' id='outcomeText'>{{outcomeText}}</div>
		<div ng-click='startGame()' style='text-decoration: underline; color: white; background-color: blue; text-align: center'>Play again</div>
	</div>	
</body>
</html>